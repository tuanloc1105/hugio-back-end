def dockerImage = "tuanloc/hugio"
def authDockerTag = ""
def userDockerTag = ""
def productDockerTag = ""
def userIdCause = currentBuild.getBuildCauses('hudson.model.Cause$UserIdCause')
def now = (new Date()).format("yyMMddHHmmss", TimeZone.getTimeZone('Asia/Ho_Chi_Minh'))

pipeline {
    agent any
    tools {
        maven "3.9.3"
        jdk "17"
    }
    environment {
        K8S_NAMESPACE = 'hugio'
    }
    stages {
        stage('Build') {
            steps {
                script {
                    sh 'mvn clean install -DskipTests=true -Dfile.encoding=UTF8 -f pom.xml'
                }
            }
        }
        stage('Copy source') {
            steps {
                script {
                    dir ("hugio-auth-service") {
                        authDockerTag = dockerImage + 'auth_' + now
                        sshagent(credentials: ['ae403']) {
                            sh 'scp -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -r ./helm_chart ae403@192.168.1.22:/home/ae403/hugio/auth_service'
                            sh 'scp -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no -r ./target ae403@192.168.1.22:/home/ae403/hugio/auth_service'
                            sh 'scp -o UserKnownHostsFile=/dev/null -o StrictHostKeyChecking=no Dockerfile ae403@192.168.1.22:/home/ae403/hugio/auth_service'
                        }
                    }
                }
            }
        }
    }
}